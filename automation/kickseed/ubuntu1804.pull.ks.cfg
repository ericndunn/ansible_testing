#Generated by Kickstart Configurator
#platform=AMD64 or Intel EM64T

#System language
# see /etc/default/locale
lang en_US.UTF-8
#Language modules to install
langsupport en_US
#System keyboard
keyboard us
#System mouse
mouse
#System timezone
timezone --utc America/New_York
#Root password
rootpw --disabled
#Initial user
user orchid --fullname "orchid" --iscrypted --password $1$lWztTfMi$4at/CmskkhlDyYmuBRCD60
#Reboot after installation
reboot
#Use text mode install
text
#Install OS instead of upgrade
install
#Use Web installation
url --url http://192.168.100.205/ubuntu
#System bootloader configuration
bootloader --location=mbr 
#Clear the Master Boot Record
zerombr yes
#Partition clearing information
clearpart --all --initlabel 
#Disk partitioning information
part / --fstype ext4 --size 1 --grow --asprimary 
part swap --recommended 
#System authorization infomation
auth  --useshadow  --enablemd5 
#Network information
network --bootproto=dhcp
#Firewall configuration
firewall --disabled --ssh 
#Do not configure the X Window System
skipx

#Package install information
%packages
@ ubuntu-standard
@ openssh-server
@ ubuntu-desktop
default-jdk
python
wget
vim
git

%post

cp /etc/apt/sources.list /etc/apt/sources.list.bak
sed -i 's/192.168.100.205/us.archive.ubuntu.com/g' /etc/apt/sources.list
apt update

apt-add-repository ppa:ansible/ansible -y
apt-get -y update
apt-get install ansible -y

cat << EOF > /etc/rc.local
#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.
/jenkins/swarm-client.sh &
exit 0
EOF

chmod +x /etc/rc.local

##Required to make JNLP agent connected.  See  https://plugins.jenkins.io/swarm
mkdir /jenkins
chmod -R 777 /jenkins
wget -O /jenkins/swarm-client.sh ftp://192.168.102.42/pub/repos/integrations/automation/jenkins/swarm-client.sh
chmod a+x /jenkins/swarm-client.sh
/jenkins/swarm-client.sh

#######################################################################################
## Create file /jenkins/ansiblepull.sh
#######################################################################################
cat << EOF > /jenkins/ansiblepull.sh
rm -rf /home/orchid/repos
/usr/bin/ansible-pull -d /home/orchid/repos -U https://ipconfigure-jenkins:ipc0nfigur3jenk1n5@github.com/ipconfigure/integrations.git -C cort-ansible steelfin_config/orchid-linux/ansible/main.yml
EOF

#######################################################################################
## Run file /jenkins/ansiblepull.sh
## Pulls GIT repo files and sets the RAID level
#######################################################################################
chmod a+x /jenkins/*.sh
/jenkins/ansiblepull.sh

