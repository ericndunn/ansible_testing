#Generated by Kickstart Configurator
#platform=AMD64 or Intel EM64T

#System language
# see /etc/default/locale
lang en_US.UTF-8
#Language modules to install
langsupport en_US

#ignoredisk --only-use=sda

#System keyboard
keyboard us
#System mouse
mouse
#System timezone
timezone --utc America/New_York
#Root password
rootpw --disabled
#Initial user
user orchid --fullname "orchid" --iscrypted --password $1$lWztTfMi$4at/CmskkhlDyYmuBRCD60
#Reboot after installation
reboot
#Use text mode install
text
#Install OS instead of upgrade
install
#Use Web installation
#url --url http://us.archive.ubuntu.com/ubuntu
url --url http://192.168.100.205/ubuntu
#url --url http://192.168.102.60/ubuntu
#System bootloader configuration
bootloader --location=mbr 
#Clear the Master Boot Record
zerombr yes
#Partition clearing information
clearpart --all --initlabel 
#Disk partitioning information
part / --fstype ext4 --size 1 --grow --asprimary 
part swap --recommended 
#System authorization infomation
auth  --useshadow  --enablemd5 
#Network information
network --bootproto=dhcp --hostname localhost.localdomain
#Firewall configuration
firewall --disabled --ssh 
#Do not configure the X Window System
skipx

#Package install information
%packages
@ ubuntu-standard
@ openssh-server
@ ubuntu-desktop
default-jdk
vlc
expect
gdebi
ssh
jq
mdadm
smartmontools
zenity
curl
wget
#ansible
git
vim
nfs-common
rsync

%post

cp //etc//apt//sources.list //etc//apt//sources.list.bak
sed -i 's/192.168.100.205/archive.ubuntu.com/g' //etc//apt//sources.list
apt-get -y update
apt-get -y upgrade
apt-get -y install --install-recommends linux-generic-hwe-16.04 xserver-xorg-hwe-16.04 
apt-get install software-properties-common -y

#######################################################################################
## Add reposity for specific Firefox install
#######################################################################################
add-apt-repository -y ppa:jonathonf/firefox-esr-52 -y 
apt-add-repository ppa:ansible/ansible -y
wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - 
sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
apt-get -y update
apt-get install google-chrome-stable
apt-get install ansible -y
apt-get install firefox-esr -y
apt-mark hold firefox-esr

#######################################################################################
## Required to make JNLP agent connected.  See  https://plugins.jenkins.io/swarm
#######################################################################################
mkdir /jenkins
chmod -R 777 /jenkins
wget -O /jenkins/swarm-client.sh ftp://192.168.102.42/pub/repos/integrations/automation/jenkins/swarm-client.sh
chmod a+x /jenkins/swarm-client.sh
sed -i -e '$i /jenkins/swarm-client.sh &\n' /etc/rc.local
/jenkins/swarm-client.sh

#######################################################################################
## Turn Off Ubuntu Automatic Updates and Release Upgrades
#######################################################################################
cp /etc/update-manager/release-upgrades /etc/update-manager/release-upgrades.orig
cp /etc/apt/apt.conf.d/10periodic /etc/apt/apt.conf.d/10periodic.orig
sed -i 's/1/0/g' /etc/apt/apt.conf.d/10periodic
sed -i 's/lts/never/g' /etc/update-manager/release-upgrades
apt-get remove ubuntu-release-upgrader-core -y

##########################################################################################
## Config hostname and hosts file to orchid
##########################################################################################
echo "orchid" > /etc/hostname
echo .
cat > /etc/hosts << EOF
127.0.0.1   localhost orchid
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
EOF
echo .

#######################################################################################
## Clean any possible RAID
#######################################################################################
umount -l /dev/md125
umount -l /dev/md126
umount -l /dev/md127
mdadm --stop /dev/md125
mdadm --stop /dev/md126
mdadm --stop /dev/md127
mdadm --zero-superblock /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf /dev/sdg
mdadm --remove /dev/md125
mdadm --remove /dev/md126
mdadm --remove /dev/md127
rm -rf /orchives

#######################################################################################
## Create file /jenkins/raid5_ansiblepull.sh
## *** Important: array_raid_level=5 ***
#######################################################################################
cat << EOF > /jenkins/raid5_ansiblepull.sh
rm -rf /home/orchid/repos
/usr/bin/ansible-pull -e "array_raid_level=5" -d /home/orchid/repos -i 'localhost,' -U https://ipconfigure-jenkins:ipc0nfigur3jenk1n5@github.com/ipconfigure/integrations.git -C edunn_pxeboot
EOF

#######################################################################################
## Run file /jenkins/raid5_ansiblepull.sh
## Pulls GIT repo files and sets the RAID level
#######################################################################################
chmod a+x /jenkins/*.sh
/jenkins/raid5_ansiblepull.sh

#######################################################################################
## Create file in case of manually cleaning RAID is required
#######################################################################################
cat << EOF > /jenkins/cleanraid.sh
#!/bin/bash
sudo fdisk -l
sudo mdadm --detail /dev/md127
sudo mdadm --detail /dev/md126
sudo mdadm --detail /dev/md125
sudo umount -l /dev/md125
sudo umount -l /dev/md126
sudo umount -l /dev/md127
sudo mdadm --stop /dev/md125
sudo mdadm --stop /dev/md126
sudo mdadm --stop /dev/md127
sudo mdadm --zero-superblock /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf /dev/sdg /dev/sdh /dev/sdi
sudo mdadm --remove /dev/md125
sudo mdadm --remove /dev/md126
sudo mdadm --remove /dev/md127
EOF
chmod 777 /jenkins/cleanraid.sh

#######################################################################################
## Create HW Report
#######################################################################################
lshw -html > /var/log/HardwareReport.html

#######################################################################################
## Create file to apply_branding and change hosts/hostname
#######################################################################################
cat << EOF > /home/orchid/apply_branding.sh
#!/bin/bash 

if [[ \$EUID > 0 ]]; then 
  echo "Please run as root/sudo and pass serial number as a parameter."
  echo "EXAMPLE: sudo ./apply_branding.sh [SERIAL NUMBER]"
  exit 1
else
orchid_install_dir="/home/orchid/repos/steelfin_config/orchid-linux/orchid_install_files"
cp \${orchid_install_dir}/poweredby_ipconfigure.png /usr/share/pixmaps/
cp \${orchid_install_dir}/orchid_background.jpg /usr/share/pixmaps/
cp \${orchid_install_dir}/orchid_background_blank.png /usr/share/pixmaps/
# The following block won't work over SSH. 
xhost +SI:localuser:lightdm
su lightdm -s /bin/bash << EOT
gsettings set com.canonical.unity-greeter logo /usr/share/pixmaps/poweredby_ipconfigure.png
gsettings set com.canonical.unity-greeter background /usr/share/pixmaps/orchid_background_blank.png
gsettings set com.canonical.unity-greeter draw-grid false
gsettings set com.canonical.unity-greeter draw-user-backgrounds false
gsettings set com.canonical.unity-greeter idle-timeout 0
EOT
serial="\$1"
if [ \$# -eq 0 ]
  then
    echo "WOOOP! WOOOP! WOOOP! No Serial Number was supplied.  Ah-Haa! Concentwaait! Twy haaah-daaah!  Weeed thee EXAMM-POO !!!!"
    echo "EXAMPLE: sudo ./apply_branding.sh 270271"
    exit 1
fi
sudo echo "orchid-\${serial}" > /etc/hostname
sudo sed -i "s/^127\\.0\\..*orchid.*/127.0.0.1 orchid-\${serial}/" /etc/hosts
sudo echo "\$serial" > /etc/steelfin-serial-number
sudo sed -i "s/^127\.0\.0\.1.*/127.0.0.1 localhost orchid-\${serial}/" /etc/hosts
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
sudo sed -i 's/192.168.100.205/us.archive.ubuntu.com/g' /etc/apt/sources.list
echo "DOES everything look correct?"
echo "DID you run the Jenkins Job - ANSIBLE_PUSH_ORCHID_SCRIPTS*...?"
echo "DID you Licence Orchid?"
echo "DID JAH? DID JAH? EH...?"
echo "Okay, if so ... then RUN THE cleanup.sh SCRIPT ... and do the sanity check after reboot."
#echo "Sleep 5 seconds and reboot"
#sleep 5
#sudo rm -rf /jenkins /home/orchid/repos /home/orchid/*.sh && sudo reboot
#sudo reboot
fi
EOF

##########################################################################################
## Create cleanup script
##########################################################################################
cat << EOF > /home/orchid/cleanup.sh
#!/bin/bash
sudo rm -rf /jenkins /home/orchid/repos /home/orchid/*.sh && sudo reboot
EOF

##########################################################################################
## Change mode to make all script executable
##########################################################################################
chmod 777 /home/orchid/*.sh

##########################################################################################
#-------------------------------Deprecated------------------------------------------------
##########################################################################################

#echo "gnome-terminal -x sh -c 'cd /home/orchid/repos/steelfin_config/orchid-linux; exec bash'" > /home/orchid/machine.sh

####
# ## TEST FILE for setting hosts and hostname
# cat << EOF > /home/orchid/config_host-serial-X.sh
# #!/bin/bash
# #Assign existing hostname to $hostn
# hostn=\$(cat /etc/hostname)
# #Display existing hostname
# echo "Existing hostname is \$hostn"
# #Ask for new hostname $newhost
# echo "Enter new hostname: "
# read newhost
# #change hostname in /etc/hosts & /etc/hostname
# sudo sed -i "s/\$hostn/\$hostn-\$newhost/g" /etc/hosts
# sudo sed -i "s/\$hostn/\$hostn-\$newhost/g" /etc/hostname
# #display new hostname
# echo "Your new hostname is \$hostn-\$newhost"
# #Press a key to reboot
# read -s -n 1 -p "Press any key to reboot"
# sudo reboot
# EOF

##########################################################################################
## Create file to change hosts and hostname - *INCLUDED IN /home/orchid/apply_branding.sh*
##########################################################################################
# cat << EOF > /home/orchid/config_host_serial.sh
# #!/bin/bash 

# if [[ \$EUID > 0 ]]; then 
#   echo "Please run as root/sudo and pass serial number as a parameter."
#   exit 1
# else

# serial="\$1"
# if [ \$# -eq 0 ]
#   then
#     echo "No Serial Number was supplied.  Ah-Haa, concentrate, twy hah-dah!"
#     exit 1
# fi
# sudo echo "orchid-\${serial}" > /etc/hostname
# sudo sed -i "s/^127\\.0\\..*orchid.*/127.0.0.1 orchid-\${serial}/" /etc/hosts
# sudo echo "\$serial" > /etc/steelfin-serial-number
# sudo sed -i "s/^127\.0\.0\.1.*/127.0.0.1 localhost orchid-\${serial}/" /etc/hosts
# echo "Sleep 5 seconds and reboot"
# sleep 5
# sudo rm -rf /jenkins /home/orchid/repos /home/orchid/*.sh && sudo reboot
# fi
# EOF